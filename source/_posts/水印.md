---
title: "ğŸ‘¨â€ğŸ’» æ°´å°æ’ä»¶"
date: 2024-01-12 21:38:11
updated: 
tags: [å·¥å…·, JavaScript]
categories: å·¥å…·ç®±
keywords:
description:
top_img: https://images.pexels.com/photos/10486875/pexels-photo-10486875.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1
comments:
cover: https://images.pexels.com/photos/10486875/pexels-photo-10486875.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1
toc:
toc_number:
toc_style_simple:
copyright: false
copyright_author:
copyright_author_href: false
copyright_url:
copyright_info:
mathjax:
katex:
aplayer:
highlight_shrink:
aside:

---

### ğŸ“‘å¦‚ä½•å®ç°ä¸€ä¸ªå‰ç«¯çš„æ°´å°æ’ä»¶

ğŸ”” æ³¨æ„

> 1: é˜²æ­¢ç”¨æˆ·é€šè¿‡æ§åˆ¶å°ç¯¡æ”¹æ ·å¼
> 
> 2: é˜²æ­¢ç”¨æˆ·é€šè¿‡æ§åˆ¶å°åˆ é™¤
>
> 3: çª—å£å˜åŒ–æ—¶è¦é‡æ–°ç”Ÿæˆæ°´å°
>
> 4: è§£å†³è¿™äº›é—®é¢˜æ—¶è¦è€ƒè™‘æ€§èƒ½é—®é¢˜

```javascript
/**
 * é¡µé¢æ·»åŠ æ°´å°æ•ˆæœ 
 */
const setWatermark = (str) => {
	const id = '1.23452384164.123412416';
	if (document.getElementById(id) !== null) document.body.removeChild(document.getElementById(id));
	const can = document.createElement('canvas');
	can.width = 200;
	can.height = 130;
	const cans = can.getContext('2d');
	cans.rotate((-20 * Math.PI) / 180);
	cans.font = '12px Vedana';
	cans.fillStyle = 'rgba(200, 200, 200, 0.30)';
	cans.textBaseline = 'top';
	
	drawTextWithNewLine(str, 5, 60, 200, cans)
	const div = document.createElement('div');
	div.id = id;
	div.style.pointerEvents = 'none';
	div.style.top = '0px';
	div.style.left = '0px';
	div.style.position = 'fixed';
	div.style.zIndex = '2147483647';
	div.style.width = `${document.documentElement.clientWidth}px`;
	div.style.height = `${document.documentElement.clientHeight}px`;
	const currentStyle = div.style.cssText
	div.style.cssText = `background: url(${can.toDataURL('image/png')}) left top repeat !important;${currentStyle};z-index: 2147483647 !important;display: block !important;`;
	document.body.appendChild(div);
	return id;
};
/**
 * canvasæ–‡å­—æ¢è¡Œ
 * @param {*} text 
 * @param {*} x 
 * @param {*} y
 * @param {*} maxWidth 
 */
function drawTextWithNewLine(text, x, y, maxWidth, ctx) {
	var lines = text.split('\n');
	var lineHeight = 20;

	for (var i = 0; i < lines.length; i++) {
		ctx.fillText(lines[i], x, y);
		y += lineHeight;
	}
}

  
/**
 * é¡µé¢æ·»åŠ æ°´å°æ•ˆæœ
 * @method set è®¾ç½®æ°´å° æœ€å¥½åŠ ä¸Š\n
 * @method del åˆ é™¤æ°´å°
 */
const watermark = {
	// è¢«ä¿®æ”¹æ ‡è¯†
	noChangeObserver: null,
	// è¢«åˆ é™¤æ ‡è¯†
	noDeleteObserver: null,
	// è®¾ç½®æ°´å°
	set: (str) => {
		if (watermark.noDeleteObserver || watermark.noChangeObserver) {
			clearOberseve()
		}
		if (watermark.watermarkListener === 0) {
			let id = setWatermark(str);
			if (document.getElementById(id) === null) id = setWatermark(str);
			noAllowDelete(str)
			noAllowChange(str)
			watermark.text = str
			// window.addEventListener('resize',resizeHandle(str))
			// æ·»åŠ ç›‘å¬å™¨
			window.addEventListener('resize', handleWindowResize);

		}
	},
	// åˆ é™¤æ°´å°
	del: (str) => {
		// window.removeEventListener('resize',resizeHandle(str));
		window.removeEventListener('resize', handleWindowResize);
		clearOberseve()
		let id = '1.23452384164.123412416';
		if (document.getElementById(id) !== null) {
			console.log('æœ‰äº†å…ˆåˆ é™¤');
			document.body.removeChild(document.getElementById(id));
		}
	},
	watermarkListener: 0
};
/**
 * é˜²æ­¢è¢«ä¿®æ”¹
 * @method noAllowChange
 */
const noAllowChange = (str) => {
	console.log('ä¸è®¸æ”¹');
	const watermark1 = document.getElementById('1.23452384164.123412416');
	// åˆ›å»ºæ°´å°çš„ç›‘å¬å™¨
	watermark.noChangeObserver = new MutationObserver(function (mutations) {
		mutations.forEach(function (mutation) {
			// æ£€æŸ¥æ˜¯å¦æ˜¯å±æ€§å˜åŒ–ï¼Œä¸”å˜åŒ–çš„å±æ€§åä¸ºstyle
			// é˜²æ­¢ç”¨æˆ·æ›´æ”¹base64çš„æ°´å°å›¾æˆ–è€…æ›´æ”¹æ°´å°çš„ä½ç½®,æ‰€æœ‰styleå˜åŒ–éƒ½è¦é‡æ–°ç”Ÿæˆæ°´å°
			if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
				const oldValue = mutation.oldValue;
				const newValue = watermark1.getAttribute('style');
				if (oldValue !== newValue) {
					console.log('style å±æ€§è¢«ä¿®æ”¹äº†');
					watermark.set(str)
				}
			}
			if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
				// ç¦æ­¢ç±»åè¢«æ·»åŠ 
				watermark.set(str)
			}
			if (mutation.type === 'attributes' && mutation.attributeName === 'id') {
				// ç¦æ­¢IDè¢«æ·»åŠ 
				// id å±æ€§å‘ç”Ÿå˜åŒ–
				let newId = watermark1.getAttribute('id');
				if (document.getElementById(newId) !== null) 
					document.body.removeChild(document.getElementById(newId));
				console.log('ç¦æ­¢ä¿®æ”¹ID');
				watermark.set(str)
			}
		});
	});
	// é…ç½®å¹¶å¯åŠ¨è§‚å¯Ÿå™¨
	const config = { attributes: true, attributeOldValue: true, subtree: true };
	watermark.noChangeObserver.observe(watermark1, config);
}


/**
 * é˜²æ­¢è¢«åˆ é™¤
 * @method noAllowDelete
 */
const noAllowDelete = (str) => {
	console.log('ä¸è®¸åˆ é™¤');
	const watermark1 = document.getElementById('1.23452384164.123412416');
	watermark.noDeleteObserver = new MutationObserver(function (mutations) {
		mutations.forEach(function (mutation) {
			console.log(mutation);
			if (mutation.removedNodes.length > 0 && mutation.removedNodes[0] === watermark1) {
				// æ°´å°å…ƒç´ è¢«åˆ é™¤ï¼Œé‡æ–°æ·»åŠ 
				console.log('æ°´å°å…ƒç´ è¢«åˆ é™¤ï¼Œé‡æ–°æ·»åŠ ');
				watermark.set(str)
			}
		});
	});
	// é…ç½®å¹¶å¯åŠ¨è§‚å¯Ÿå™¨
	const config = { childList: true };
	watermark.noDeleteObserver.observe(document.body, config);
}

/**
 * æ¸…ç©ºæ‰€æœ‰ç›‘æ§
 * @method clearOberseve
 */
const clearOberseve = () => {
	watermark.noDeleteObserver.disconnect()
	watermark.noChangeObserver.disconnect()
	watermark.watermarkListener = 0
}

/**
 * ç›‘å¬çª—å£å˜åŒ–
 * @method resizeHandle
 */
// const resizeHandle:any = (str:string) => {
// 	return () => {
// 		console.log('å­˜åœ¨ç›‘å¬å™¨');
// 		if(flag) {
// 			watermark.noDeleteObserver.disconnect()
// 			setWatermark(str)
// 			noAllowChange(str)
// 			watermark.watermarkListener++
// 			console.log('æ£€æµ‹åˆ°çª—å£å˜åŒ–');
// 		} else {
// 			return
// 		}
// 	}

// }
function handleWindowResize() {
	console.log('çª—å£å¤§å°å˜åŒ–äº†');
	// å…·ä½“çš„å¤„ç†é€»è¾‘
	watermark.noDeleteObserver.disconnect()
	setWatermark(watermark.text || '')
	noAllowChange(watermark.text || '')
	watermark.watermarkListener++
	console.log('æ£€æµ‹åˆ°çª—å£å˜åŒ–');
}

// å¯¼å‡ºæ–¹æ³•
export default watermark;

```

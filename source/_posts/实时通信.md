---
title: "ğŸšŒ WebSocketå®æ—¶é€šä¿¡"
date: 2023-04-03 21:38:11
updated: 2023-07-10 16:06:06
tags: [ å‰ç«¯]
categories: åç«¯
keywords:
description:
top_img: https://yh-blog.oss-cn-beijing.aliyuncs.com/image-20230710172018469.png
comments:
cover: https://yh-blog.oss-cn-beijing.aliyuncs.com/image-20230710172018469.png
toc:
toc_number:
toc_style_simple:
copyright: false
copyright_author:
copyright_author_href: false
copyright_url:
copyright_info:
mathjax:
katex:
aplayer:
highlight_shrink:
aside:

---
## åŸºäºWebSocketå®ç°çš„å®æ—¶é€šä¿¡

    1. å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹WebSocketè¿æ¥ï¼šå®¢æˆ·ç«¯å‘æŒ‡å®šçš„æœåŠ¡å™¨åœ°å€å‘é€è¿æ¥è¯·æ±‚ï¼ŒæœåŠ¡å™¨éªŒè¯è¯·æ±‚æ˜¯å¦åˆæ³•å¹¶å“åº”ä¸€ä¸ªçŠ¶æ€ç æ˜¾ç¤ºæ˜¯å¦é“¾æ¥æˆåŠŸæˆ–è€…å¤±è´¥ã€‚
    2. æœåŠ¡å™¨ä¿æŒè¿æ¥å¹¶ç›‘å¬äº‹ä»¶ï¼šä¸€æ—¦è¿æ¥å»ºç«‹æˆåŠŸï¼ŒæœåŠ¡å™¨å°±å›ä¿æŒè¿æ¥å¹¶ç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„äº‹ä»¶ã€‚ä¾‹å¦‚ï¼Œå¦‚è¿‡ç”¨æˆ·åœ¨æŸä¸ªé¡µé¢ä¸Šè¿›è¡Œç‚¹èµæ“ä½œï¼Œå®¢æˆ·ç«¯ä¼šå°†è¯¥äº‹ä»¶å‘é€åˆ°æœåŠ¡å™¨ã€‚
    3. æœåŠ¡å™¨å‘æŒ‡å®šçš„ç”¨æˆ·æ¨é€æ¶ˆæ¯ï¼šå½“æœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„ç‚¹èµäº‹ä»¶ï¼Œä»–ä¼šæ ¹æ®æŒ‡å®šçš„ç”¨æˆ·IDæ‰¾åˆ°å¯¹åº”çš„websocketè¿æ¥ï¼Œå¹¶å‘è¯¥è¿æ¥å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œå‘ŠçŸ¥è¢«ç‚¹èµç”¨æˆ·æ”¶åˆ°äº†ç‚¹èµã€‚
    4. å®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯å¹¶æç¤ºï¼šå½“è¢«ç‚¹èµç”¨æˆ·çš„å®¢æˆ·ç«¯æ¥å—åˆ°æœåŠ¡å™¨æ¨é€çš„æ¶ˆæ¯æ—¶ï¼Œå®ƒå¯æ ¹æ®æ¶ˆæ¯å†…å®¹ç”Ÿæˆç›¸åº”çš„æç¤ºæˆ–è€…å¼¹æ¡†ï¼Œå‘ŠçŸ¥ç”¨æˆ·æ”¶åˆ°äº†ç‚¹èµã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒWebSocketæŠ€æœ¯çš„å®ç°å¯èƒ½å› ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶è€Œå¼‚ï¼Œä½†åŸºæœ¬çš„å·¥ä½œåŸç†æ˜¯ç±»ä¼¼çš„ã€‚æ­¤å¤–ï¼ŒWebSockteæŠ€æœ¯ä¹Ÿæœ‰ä¸€äº›é™åˆ¶ï¼Œå’Œå®‰å…¨é—®é¢˜éœ€è¦è€ƒè™‘ï¼Œä¾‹å¦‚æµè§ˆå™¨å…¼å®¹æ€§ï¼Œè·¨åŸŸè®¿é—®ç­‰ã€‚å› æ­¤ï¼Œåœ¨å®ç°è¿‡ç¨‹ä¸­éœ€è¦ä»”ç»†è€ƒè™‘è¿™äº›é—®é¢˜ï¼Œå¹¶é‡‡å–é€‚å½“çš„æªæ–½è¿›è¡Œå¤„ç†ã€‚


```javascript

let websock = null;
let global_callback = null;
const serverPort = "9999"; // webSocketè¿æ¥ç«¯å£
const wsuri = "ws://" + window.location.hostname + ":" + serverPort + "/wsdemo";

function createWebSocket(callback) {
  if (websock == null || typeof websock !== WebSocket) {
    initWebSocket(callback);
  }
}
function initWebSocket(callback) {
  global_callback = callback;
  // åˆå§‹åŒ–websocket
  websock = new WebSocket(wsuri);
  websock.onmessage = function (e) {
    websocketonmessage(e);
  };
  websock.onclose = function (e) {
    websocketclose(e);
  };
  websock.onopen = function () {
    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
    // @ts-ignore
    websocketOpen();
  };
  // è¿æ¥å‘ç”Ÿé”™è¯¯çš„å›è°ƒæ–¹æ³•
  websock.onerror = function () {
    console.log("WebSocketè¿æ¥å‘ç”Ÿé”™è¯¯");
  };
}
// å®é™…è°ƒç”¨çš„æ–¹æ³•
function sendSock(agentData) {
  if (websock.readyState === websock.OPEN) {
    // è‹¥æ˜¯wså¼€å¯çŠ¶æ€
    websocketsend(agentData);
  } else if (websock.readyState === websock.CONNECTING) {
    // è‹¥æ˜¯ æ­£åœ¨å¼€å¯çŠ¶æ€ï¼Œåˆ™ç­‰å¾…1såé‡æ–°è°ƒç”¨
    setTimeout(function () {
      sendSock(agentData);
    }, 1000);
  } else {
    // è‹¥æœªå¼€å¯ ï¼Œåˆ™ç­‰å¾…1såé‡æ–°è°ƒç”¨
    setTimeout(function () {
      sendSock(agentData);
    }, 1000);
  }
}
function closeSock() {
  websock.close();
}
// æ•°æ®æ¥æ”¶
function websocketonmessage(msg) {
  // console.log("æ”¶åˆ°æ•°æ®ï¼š"+JSON.parse(e.data));
  // console.log("æ”¶åˆ°æ•°æ®ï¼š"+msg);
  // global_callback(JSON.parse(msg.data));
  // æ”¶åˆ°ä¿¡æ¯ä¸ºBlobç±»å‹æ—¶
  let result = null;
  // debugger
  if (msg.data instanceof Blob) {
    const reader = new FileReader();
    reader.readAsText(msg.data, "UTF-8");
    reader.onload = (e) => {
      console.log(e);
      if (typeof reader.result === "string") {
        result = JSON.parse(reader.result);
      }
      //console.log("websocketæ”¶åˆ°", result);
      global_callback(result);
    };
  } else {
    result = JSON.parse(msg.data);
    //console.log("websocketæ”¶åˆ°", result);
    global_callback(result);
  }
}
// æ•°æ®å‘é€
function websocketsend(agentData) {
  console.log("å‘é€æ•°æ®ï¼š" + agentData);
  websock.send(agentData);
}
// å…³é—­
function websocketclose(e) {
  console.log("connection closed (" + e.code + ")");
}
function websocketOpen(e) {
  console.log(e);
  console.log("è¿æ¥æ‰“å¼€");
}
export { sendSock, createWebSocket, closeSock };


```
> å®¢æˆ·ç«¯åœ¨ç”¨æˆ·ç™»å½•çš„æ—¶å€™å»ºç«‹è¿æ¥
```java
package com.example.statisticback.controller;

import java.util.concurrent.CopyOnWriteArraySet;

import javax.websocket.*;
import javax.websocket.server.PathParam;
import javax.websocket.server.ServerEndpoint;

import org.springframework.stereotype.Component;

import lombok.extern.slf4j.Slf4j;

@Component
@Slf4j
@ServerEndpoint("/wsdemo")  // æ¥å£è·¯å¾„ ws://localhost:8087/webSocket/userId;

public class WebSocket {

    //ä¸æŸä¸ªå®¢æˆ·ç«¯çš„è¿æ¥ä¼šè¯ï¼Œéœ€è¦é€šè¿‡å®ƒæ¥ç»™å®¢æˆ·ç«¯å‘é€æ•°æ®
    private Session session;
    //concurrentåŒ…çš„çº¿ç¨‹å®‰å…¨Setï¼Œç”¨æ¥å­˜æ”¾æ¯ä¸ªå®¢æˆ·ç«¯å¯¹åº”çš„MyWebSocketå¯¹è±¡ã€‚
    //è™½ç„¶@Componenté»˜è®¤æ˜¯å•ä¾‹æ¨¡å¼çš„ï¼Œä½†springbootè¿˜æ˜¯ä¼šä¸ºæ¯ä¸ªwebsocketè¿æ¥åˆå§‹åŒ–ä¸€ä¸ªbeanï¼Œæ‰€ä»¥å¯ä»¥ç”¨ä¸€ä¸ªé™æ€setä¿å­˜èµ·æ¥ã€‚
    //  æ³¨ï¼šåº•ä¸‹WebSocketæ˜¯å½“å‰ç±»å
    private static CopyOnWriteArraySet<WebSocket> webSockets =new CopyOnWriteArraySet<>();
    // ç”¨æ¥å­˜åœ¨çº¿è¿æ¥ç”¨æˆ·ä¿¡æ¯

    /**
     * é“¾æ¥æˆåŠŸè°ƒç”¨çš„æ–¹æ³•
     */
    @OnOpen
    public void onOpen(Session session, @PathParam(value="userId")String userId) {
        try {
            this.session = session;
            webSockets.add(this);
            System.out.println(session);
            log.info("ã€websocketæ¶ˆæ¯ã€‘æœ‰æ–°çš„è¿æ¥ï¼Œæ€»æ•°ä¸º:"+webSockets.size());
        } catch (Exception e) {
        }
    }

    /**
     * é“¾æ¥å…³é—­è°ƒç”¨çš„æ–¹æ³•
     */
    @OnClose
    public void onClose() {
        try {
            webSockets.remove(this);
            log.info("ã€websocketæ¶ˆæ¯ã€‘è¿æ¥æ–­å¼€ï¼Œæ€»æ•°ä¸º:"+webSockets.size());
        } catch (Exception e) {
        }
    }
    /**
     * æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯åè°ƒç”¨çš„æ–¹æ³•
     *
     * @param message
     */
    @OnMessage
    public void onMessage(String message) {
        log.info("ã€websocketæ¶ˆæ¯ã€‘æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯:"+message);
    }

    /** å‘é€é”™è¯¯æ—¶çš„å¤„ç†
     * @param session
     * @param error
     */
    @OnError
    public void onError(Session session, Throwable error) {

        log.error("ç”¨æˆ·é”™è¯¯,åŸå› :"+error.getMessage());
        error.printStackTrace();
    }


    // æ­¤ä¸ºå¹¿æ’­æ¶ˆæ¯
    public void sendAllMessage(String message) {
        log.info("ã€websocketæ¶ˆæ¯ã€‘å¹¿æ’­æ¶ˆæ¯:"+message);
        for(WebSocket webSocket : webSockets) {
            try {
                if(webSocket.session.isOpen()) {
                    webSocket.session.getAsyncRemote().sendText(message);
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    // æ­¤ä¸ºå•ç‚¹æ¶ˆæ¯
    public void sendOneMessage( String message) {
        if (message.length() == 0) {
            message = "æ¥è‡ªæœåŠ¡å™¨çš„æ•°æ®";
        }
        if (session != null&&session.isOpen()) {
            try {
                log.info("ã€websocketæ¶ˆæ¯ã€‘ å•ç‚¹æ¶ˆæ¯:"+message);
                session.getAsyncRemote().sendText(message);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    // æ­¤ä¸ºå•ç‚¹æ¶ˆæ¯(å¤šäºº)
    public void sendMoreMessage(String[] userIds, String message) {
        for(String userId:userIds) {
            if (session != null&&session.isOpen()) {
                try {
                    log.info("ã€websocketæ¶ˆæ¯ã€‘ å•ç‚¹æ¶ˆæ¯:"+message);
                    session.getAsyncRemote().sendText(message);
                } catch (Exception e) {
                    e.printStackTrace();
            }
            }
            }

            }

            }


```
